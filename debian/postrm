#!/usr/bin/env python3
import sys
import shutil
import subprocess


def main():
    # Check if an action is provided
    if len(sys.argv) < 2:
        sys.exit(0)

    action = sys.argv[1]
    if action in ('remove', 'purge'):
        dir_path = '/usr/share/ethercat_igh_dkms'
        # Attempt to remove the directory if it's empty
        try:
            shutil.rmtree(dir_path)
        except OSError:
            # Directory not empty or cannot be removed
            pass
        # Remove the modules from dkms
        cmd = ['dkms', 'status']
        try:
            result = subprocess.run(cmd,
                                    stdout=subprocess.PIPE,
                                    stderr=subprocess.PIPE,
                                    text=True,
                                    shell=True)
            if result.returncode == 0:
                for line in result.stdout.splitlines():
                    if 'ethercat' in line:
                        module = line.split(',')[0]
                        cmd = ['dkms', 'remove', module, '--all']
                        try:
                            subprocess.run(cmd,
                                           stdout=subprocess.PIPE,
                                           stderr=subprocess.PIPE,
                                           text=True,
                                           check=True,
                                           shell=True)
                        except Exception as e:
                            print(f"Error: {cmd} failed.")
                            sys.exit(1)
                    break
        except Exception as e:
            print(f"Error: {cmd} failed.")
            sys.exit(1)


if __name__ == '__main__':
    main()
